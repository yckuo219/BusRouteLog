<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>GPS åœ°åœ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    #menu {
      position: absolute;
      top: 10px; left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 8px 12px;
      border-radius: 8px;
      font-family: sans-serif;
      box-shadow: 0 0 6px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    button {
      font-size: 14px;
      border: none;
      border-radius: 6px;
      background: #0078ff;
      color: white;
      padding: 6px 10px;
      cursor: pointer;
    }
    button:hover { background: #005fcc; }
    #status {
      margin-top: 8px;
      font-size: 13px;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="menu">
    <button onclick="location.href='index.html'">è¿”å›è¨˜éŒ„é </button>
    <div id="status">è¼‰å…¥ä¸­...</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
    const sheetID = "12KJUVKw9hKgWN2894agnsSwQoO0X8zI4_P2_Q9kvzyU"; // ä½ çš„è©¦ç®—è¡¨ ID
    const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json`;

    let map, route, startMarker, endMarker;
    let lastDataLength = 0;

    // ğŸ”¹ æŠ“å– Google è©¦ç®—è¡¨è³‡æ–™
    async function fetchData() {
      try {
        const res = await fetch(sheetURL + "&rand=" + Math.random());
        const text = await res.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        return json.table.rows.map(r => ({
          time: r.c[0]?.v,
          lat: parseFloat(r.c[1]?.v),
          lng: parseFloat(r.c[2]?.v)
        })).filter(d => !isNaN(d.lat) && !isNaN(d.lng));
      } catch (err) {
        console.error("è®€å–è³‡æ–™å¤±æ•—", err);
        return [];
      }
    }

    // ğŸ”¹ åˆå§‹åŒ–åœ°åœ–
    async function initMap() {
      const data = await fetchData();
      if (data.length === 0) {
        document.getElementById("status").innerText = "âš ï¸ å°šç„¡åº§æ¨™è³‡æ–™";
        return;
      }

      map = L.map('map').setView([data[0].lat, data[0].lng], 15);

      // ğŸ—ºï¸ ä¹¾æ·¨é¢¨æ ¼çš„åœ°åœ–ï¼ˆåƒ…é“è·¯èˆ‡æ¨™ç±¤ï¼‰
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      const path = data.map(p => [p.lat, p.lng]);

      route = L.polyline(path, { color: 'red', weight: 4 }).addTo(map);
      startMarker = L.marker(path[0]).addTo(map).bindPopup("èµ·é»");
      endMarker = L.marker(path[path.length - 1]).addTo(map).bindPopup("çµ‚é»");

      map.fitBounds(route.getBounds());

      document.getElementById("status").innerText =
        `âœ… å·²è¼‰å…¥ ${data.length} ç­†è³‡æ–™ï¼ˆ${new Date().toLocaleTimeString()}ï¼‰`;

      lastDataLength = data.length;
    }

    // ğŸ”¹ æ¯ 10 ç§’è‡ªå‹•æ›´æ–°
    async function updateRoute() {
      const data = await fetchData();
      if (data.length === 0) return;

      const path = data.map(p => [p.lat, p.lng]);
      route.setLatLngs(path);
      endMarker.setLatLng(path[path.length - 1]);

      document.getElementById("status").innerText =
        `ğŸ”„ æ›´æ–°æ™‚é–“ï¼š${new Date().toLocaleTimeString()}ï¼ˆå…± ${data.length} ç­†ï¼‰`;

      // è‹¥è³‡æ–™è®Šå‹•é¡¯è‘—ï¼Œé‡æ–°ç¸®æ”¾
      if (data.length !== lastDataLength) {
        map.fitBounds(route.getBounds());
        lastDataLength = data.length;
      }
    }

    // åˆå§‹åŒ– + è‡ªå‹•æ›´æ–°
    initMap().then(() => setInterval(updateRoute, 10000));
  </script>
</body>
</html>
